apiVersion: apps/v1
kind: Deployment
metadata:
  name: coturn-server
  namespace: api-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: coturn-server
  template:
    metadata:
      labels:
        app: coturn-server
    spec:
      # Use host networking to avoid NAT issues
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - name: coturn
        image: coturn/coturn:latest
        ports:
        - containerPort: 3478
          protocol: UDP
          hostPort: 3478
        - containerPort: 3478
          protocol: TCP
          hostPort: 3478
        - containerPort: 5349
          protocol: UDP
          hostPort: 5349
        - containerPort: 5349
          protocol: TCP
          hostPort: 5349
        env:
        - name: TURN_USERNAME
          value: "webrtc-user"
        - name: TURN_PASSWORD
          value: "secure-password"
        - name: EXTERNAL_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        command:
          - turnserver
          - -n
          - --log-file=stdout
          - --fingerprint
          - --lt-cred-mech
          - --user=webrtc-user:secure-password
          - --realm=k8s.local
          - --min-port=49152
          - --max-port=49252
          - --verbose
---
apiVersion: v1
kind: Service
metadata:
  name: coturn-service
  namespace: api-system
spec:
  # Use NodePort or ClusterIP when using hostNetwork
  type: ClusterIP
  clusterIP: None  # Headless service
  ports:
  - name: turn-udp
    port: 3478
    protocol: UDP
  - name: turn-tcp
    port: 3478
    protocol: TCP
  selector:
    app: coturn-server